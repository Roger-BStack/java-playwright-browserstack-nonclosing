/*
 * This file was generated by the Gradle 'init' task.
 */
buildscript {
    repositories {
        mavenCentral()
        mavenLocal()
    }
    dependencies {
        // Declare your plugin as a classpath dependency
        classpath 'com.browserstack:gradle-sdk:1.1.2'
    }
}

plugins {
    id 'java-library'
}

repositories {
    mavenCentral()
    mavenLocal()
    maven {
        url = uri('https://repo.maven.apache.org/maven2/')
    }
}

dependencies {
    testImplementation libs.org.junit.jupiter.junit.jupiter.engine
    testImplementation libs.org.junit.vintage.junit.vintage.engine
    implementation 'org.seleniumhq.selenium:selenium-java:4.1.0'
    implementation 'com.microsoft.playwright:playwright:1.56.0'
    implementation 'com.googlecode.json-simple:json-simple:1.1'
    implementation 'org.apache.httpcomponents:httpclient:4.5.13'
    implementation 'com.browserstack:browserstack-local-java:1.0.6'
    implementation 'com.browserstack:browserstack-java-sdk:latest.release'
    implementation 'org.yaml:snakeyaml:2.0'
    implementation 'io.netty:netty-transport-native-epoll:4.1.69.Final'
    implementation 'io.netty:netty-transport-native-kqueue:4.1.69.Final'
}

group = 'org.example'
version = '1.0-SNAPSHOT'
description = 'Junit5Basics'
java.sourceCompatibility = JavaVersion.VERSION_1_8

boolean useBStack = Boolean.parseBoolean(System.getProperty("run-on-bstack", "false"))
println "useBStack: ${useBStack}"

def browserstackSDKArtifact = configurations.testRuntimeClasspath.find {
    it.name.startsWith('browserstack-java-sdk')
}
if(useBStack && browserstackSDKArtifact != null){
    apply plugin: 'com.browserstack.gradle-sdk'
}


test {
    dependsOn assemble, testClasses
    useJUnitPlatform()
    testLogging.showStandardStreams = true

    // Reduce parallel forks to prevent worker crashes
    maxParallelForks = 1  // Start with 1, increase gradually

    // Handle test process failures gracefully
    ignoreFailures = false
    failFast = false

    // Increase memory for test processes
    jvmArgs '-Xmx2g', '-XX:MaxMetaspaceSize=512m'
    jvmArgs += "-Drun-on-bstack=${useBStack}"

    // Configure BrowserStack SDK agent
    if (useBStack && browserstackSDKArtifact != null) {

        println("BrowserStack SDK agent detected: ${browserstackSDKArtifact}")
        jvmArgs += "-javaagent:${browserstackSDKArtifact}"
    }

    include '**/NonClosingTest.class'

    testLogging {
        events "PASSED", "FAILED", "SKIPPED"
    }
}